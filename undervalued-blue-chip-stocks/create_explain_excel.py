from datetime import datetime
import pandas as pd

def create_metrics_explanation_file():
    """
    모든 지표 설명을 엑셀 파일로 생성
    """
    # 버핏 스타일 지표 설명
    buffett_metrics = [
        {
            '지표(영문)': 'Ticker',
            '한국어 설명': '종목코드',
            '의미 해석': '주식 시장에서 사용하는 고유 기호',
            '좋은 신호': '-',
            '주의 신호': '-'
        },
        {
            '지표(영문)': 'Name',
            '한국어 설명': '회사명',
            '의미 해석': '상장회사 공식 명칭',
            '좋은 신호': '-',
            '주의 신호': '-'
        },
        {
            '지표(영문)': 'Sector',
            '한국어 설명': '업종/섹터',
            '의미 해석': '기술, 헬스케어, 금융 등 산업 분류',
            '좋은 신호': '성장성이 좋은 섹터',
            '주의 신호': '침체 산업'
        },
        {
            '지표(영문)': 'Price',
            '한국어 설명': '현재 주가',
            '의미 해석': '현재 시장에서 거래되는 주식 가격',
            '좋은 신호': '적정 가격대',
            '주의 신호': '지나치게 고가 또는 저가'
        },
        {
            '지표(영문)': 'FairValue_Composite',
            '한국어 설명': '종합 적정가',
            '의미 해석': '여러 가치 평가 모델을 종합하여 계산한 공정 가치',
            '좋은 신호': '현재가보다 높은 적정가',
            '주의 신호': '현재가보다 낮은 적정가'
        },
        {
            '지표(영문)': 'Discount_Pct',
            '한국어 설명': '할인율 (%)',
            '의미 해석': '적정가 대비 현재 주가가 낮은 정도',
            '좋은 신호': '양수 값 (저평가)',
            '주의 신호': '음수 값 (고평가)'
        },
        {
            '지표(영문)': 'MktCap($B)',
            '한국어 설명': '시가총액 (10억 달러)',
            '의미 해석': '회사의 전체 시장 가치',
            '좋은 신호': '업종 평균 적정 규모',
            '주의 신호': '지나치게 작거나 큰 규모'
        },
        {
            '지표(영문)': 'PE',
            '한국어 설명': '주가수익비율',
            '의미 해석': '주가를 주당순이익으로 나눈 값',
            '좋은 신호': '15-20 이하 (업종별 차이 있음)',
            '주의 신호': '30 이상 (고평가 가능성)'
        },
        {
            '지표(영문)': 'PEG',
            '한국어 설명': '주가수익비율 성장률 배수',
            '의미 해석': 'PER을 성장률로 나눈 값',
            '좋은 신호': '1.0 이하 (이상적)',
            '주의 신호': '2.0 이상 (성장 대비 비쌈)'
        },
        {
            '지표(영문)': 'EV_EBITDA',
            '한국어 설명': '기업가치 대비 EBITDA 비율',
            '의미 해석': '기업 인수 비용 대비 영업이익',
            '좋은 신호': '10 이하 (저평가)',
            '주의 신호': '15 이상 (고평가)'
        },
        {
            '지표(영문)': 'FCF_Yield',
            '한국어 설명': '자유현금흐름 수익률',
            '의미 해석': '주가 대비 자유현금흐름 비율',
            '좋은 신호': '5% 이상 (높은 현금창출)',
            '주의 신호': '2% 이하 (낮은 현금창출)'
        },
        {
            '지표(영문)': 'ROE(info)',
            '한국어 설명': '자기자본이익률',
            '의미 해석': '자본 대비 순이익률, 수익성 지표',
            '좋은 신호': '15% 이상 (높은 자본 효율)',
            '주의 신호': '8% 이하 (낮은 수익성)'
        },
        {
            '지표(영문)': 'GrowthScore',
            '한국어 설명': '성장성 점수',
            '의미 해석': '매출 성장, 수익 성장 등 성장성 종합 점수',
            '좋은 신호': '70점 이상',
            '주의 신호': '40점 이하'
        },
        {
            '지표(영문)': 'QualityScore',
            '한국어 설명': '질 점수',
            '의미 해석': '수익성, 재무건전성, 경영 효율성 종합 점수',
            '좋은 신호': '70점 이상',
            '주의 신호': '40점 이하'
        },
        {
            '지표(영문)': 'ValueScore',
            '한국어 설명': '가치 점수',
            '의미 해석': '저평가 정도, 다양한 가치 지표 종합 점수',
            '좋은 신호': '70점 이상',
            '주의 신호': '40점 이하'
        },
        {
            '지표(영문)': 'TotalScore',
            '한국어 설명': '종합 총점',
            '의미 해석': '성장성 + 질 + 가치 점수의 가중합',
            '좋은 신호': '70점 이상',
            '주의 신호': '50점 이하'
        },
        {
            '지표(영문)': 'ValuationAdjustedScore',
            '한국어 설명': '가치 조정 종합점수',
            '의미 해석': '종합 총점에 할인율을 추가 반영한 최종 점수',
            '좋은 신호': '80점 이상',
            '주의 신호': '50점 이하'
        }
    ]

    # 트레이딩 지표 설명
    trading_metrics = [
        {
            '지표(영문)': 'Sector',
            '한국어 설명': '업종/섹터',
            '의미 해석': '주식이 속한 산업 분야',
            '트레이딩 중요도': '중간',
            '좋은 조건': '모멘텀 있는 섹터'
        },
        {
            '지표(영문)': 'Price',
            '한국어 설명': '현재 주가',
            '의미 해석': '실시간 거래 가격',
            '트레이딩 중요도': '높음',
            '좋은 조건': '적정 가격대'
        },
        {
            '지표(영문)': 'DollarVol($M)',
            '한국어 설명': '달러 거래량 (백만 달러)',
            '의미 해석': '하루 거래 대금',
            '트레이딩 중요도': '매우 높음',
            '좋은 조건': 'Swing: 5M↑, Day: 20M↑'
        },
        {
            '지표(영문)': 'RVOL',
            '한국어 설명': '상대 거래량',
            '의미 해석': '평균 대비 거래량 비율 (1.0 = 평균)',
            '트레이딩 중요도': '높음',
            '좋은 조건': 'Swing: 1.2↑, Day: 2.0↑'
        },
        {
            '지표(영문)': 'ATR_PCT',
            '한국어 설명': '평균 실제 범위 (%)',
            '의미 해석': '주가 변동성 크기',
            '트레이딩 중요도': '높음',
            '좋은 조건': 'Swing: 2-8%, Day: 3-15%'
        },
        {
            '지표(영문)': 'SMA20',
            '한국어 설명': '20일 이동평균',
            '의미 해석': '단기 추세선',
            '트레이딩 중요도': '높음',
            '좋은 조건': '상승 추세, Price > SMA20'
        },
        {
            '지표(영문)': 'SMA50',
            '한국어 설명': '50일 이동평균',
            '의미 해석': '중기 추세선',
            '트레이딩 중요도': '중간',
            '좋은 조건': '상승 추세, SMA20 > SMA50'
        },
        {
            '지표(영문)': 'RET5',
            '한국어 설명': '5일 수익률',
            '의미 해석': '최근 5일간 주가 등락율',
            '트레이딩 중요도': '높음',
            '좋은 조건': 'Day: 3%↑, Swing: 양수'
        },
        {
            '지표(영문)': 'RET20',
            '한국어 설명': '20일 수익률',
            '의미 해석': '최근 20일간 주가 등락율',
            '트레이딩 중요도': '중간',
            '좋은 조건': 'Swing: 0%↑ (양수)'
        },
        {
            '지표(영문)': 'MomentumScore',
            '한국어 설명': '모멘텀 점수',
            '의미 해석': '단기 주가 추세 강도 (최근 상승력)',
            '트레이딩 중요도': '매우 높음',
            '좋은 조건': '70점 이상'
        },
        {
            '지표(영문)': 'TrendScore',
            '한국어 설명': '트렌드 점수',
            '의미 해석': '장기 추세 방향성 (상승/하락/횡보)',
            '트레이딩 중요도': '높음',
            '좋은 조건': '70점 이상'
        },
        {
            '지표(영문)': 'LiquidityScore',
            '한국어 설명': '유동성 점수',
            '의미 해석': '매매 용이성 (거래량, 거래대금 종합)',
            '트레이딩 중요도': '높음',
            '좋은 조건': '70점 이상'
        },
        {
            '지표(영문)': 'VolatilityScore',
            '한국어 설명': '변동성 점수',
            '의미 해석': '적정 변동성 (너무 낮거나 높지 않은 적정 수준)',
            '트레이딩 중요도': '중간',
            '좋은 조건': '60-80점'
        },
        {
            '지표(영문)': 'TotalScore',
            '한국어 설명': '종합 총점',
            '의미 해석': '트레이딩 적합도 종합 점수',
            '트레이딩 중요도': '매우 높음',
            '좋은 조건': '70점 이상'
        }
    ]

    # 엑셀 파일 생성
    ts = datetime.now().strftime("%Y%m%d_%H%M%S")
    filename = f"Stock_Metrics_Explanation_{ts}.xlsx"

    with pd.ExcelWriter(filename, engine='openpyxl') as writer:
        # 버핏 지표 시트
        buffett_df = pd.DataFrame(buffett_metrics)
        buffett_df.to_excel(writer, sheet_name='버핏_지표_설명', index=False)

        # 트레이딩 지표 시트
        trading_df = pd.DataFrame(trading_metrics)
        trading_df.to_excel(writer, sheet_name='트레이딩_지표_설명', index=False)

        # 시트 서식 조정 (컬럼 너비 자동 조정)
        for sheet_name in writer.sheets:
            worksheet = writer.sheets[sheet_name]
            for column in worksheet.columns:
                max_length = 0
                column_letter = column[0].column_letter
                for cell in column:
                    try:
                        if len(str(cell.value)) > max_length:
                            max_length = len(str(cell.value))
                    except:
                        pass
                adjusted_width = min(max_length + 2, 50)
                worksheet.column_dimensions[column_letter].width = adjusted_width

    print(f"✅ 지표 설명 파일이 생성되었습니다: {filename}")
    print("📊 포함된 시트:")
    print("   - 버핏_지표_설명: 가치투자 지표 해설")
    print("   - 트레이딩_지표_설명: 단기매매 지표 해설")

    return filename


# 파일 생성 실행
if __name__ == "__main__":
    explanation_file = create_metrics_explanation_file()